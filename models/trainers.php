<?php
/**
 * Trainers Model for Schedule Component
 * 
 * @package    Training schedule
 * @subpackage Components
 * @link http://docs.joomla.org/Developing_a_Model-View-Controller_Component_-_Part_4
 * @license		GNU/GPL
 */

// No direct access
defined( '_JEXEC' ) or die( 'Restricted access' );

jimport( 'joomla.application.component.model' );

/**
 * Trainer Model
 *
 * @package    Training schedule
 * @subpackage Components
 */
class SchedulesModelTrainers extends JModel
{
	/**
	 * Trainers data array
	 *
	 * @var array
	 */
	var $_data;
        /**
         * Total number of calendars
         *
         *  @var int
         */
        var $_total = null;
        /**
         * @var JPagination object
         */
        var $_pagination = null;

        /**
        * Constructor
        */
        function __construct()
        {
            global $mainframe;
            parent::__construct();
            // Get the pagination request variables
            $limit = $mainframe->getUserStateFromRequest(
            'global.list.limit',
            'limit', $mainframe->getCfg('list_limit'));
            $limitstart = $mainframe->getUserStateFromRequest(
            $option.'limitstart', 'limitstart', 0);
            // Set the state pagination variables
            $this->setState('limit', $limit);
            $this->setState('limitstart', $limitstart);
        }

	/**
	 * Returns the query
	 * @return string The query to be used to retrieve the rows from the database
	 */
	function _buildQuery()
	{
		$query = ' SELECT * '
			. ' FROM #__schedule_trainers '
                        .$this->_buildQueryWhere()
                        .$this->_buildQueryOrderBy()
		;
//var_dump($query);exit;
		return $query;
	}

	/**
	 * Retrieves the schedule data
	 * @return array Array of objects containing the data from the database
	 */
	function getData()
	{
		// Lets load the data if it doesn't already exist
		if (empty( $this->_data ))
		{
                    $query = $this->_buildQuery();
                    $limitstart = $this->getState('limitstart');
                    $limit = $this->getState('limit');
                    $this->_data = $this->_getList( $query,$limitstart,$limit );
		}

		return $this->_data;
	}
        /**
        * Get a pagination object
        *
        * @access public
        * @return pagination object
        */
        function getPagination()
        {
            if (empty($this->_pagination))
            {
                // Import the pagination library
                jimport('joomla.html.pagination');
                // Prepare the pagination values
                $total = $this->getTotal();
                $limitstart = $this->getState('limitstart');
                $limit = $this->getState('limit');
                // Create the pagination object
                $this->_pagination = new JPagination($total,$limitstart,$limit);
            }
            return $this->_pagination;
        }
        /**
        * Get number of items
        *
        * @access public
        * @return integer
        */
        function getTotal()
        {
            if (empty($this->_total))
            {
                $query = $this->_buildQuery();
                $this->_total = $this->_getListCount($query);
            }
            return $this->_total;
        }
        /**
        * Build the ORDER part of a query
        *
        * @return string part of an SQL query
        */
        function _buildQueryOrderBy()
        {
            global $mainframe, $option;
            // Array of allowable order fields
            $orders = array('fam', 'id');
            // Get the order field and direction, default order field
            // is 'fam', default direction is ascending
            $filter_order = $mainframe->getUserStateFromRequest(
            $option.'filter_order', 'filter_order', 'fam');
            $filter_order_Dir = strtoupper(
            $mainframe->getUserStateFromRequest(
            $option.'filter_order_Dir', 'filter_order_Dir', 'ASC'));
            // Validate the order direction, must be ASC or DESC
            if ($filter_order_Dir != 'ASC' && $filter_order_Dir != 'DESC')
            {
                $filter_order_Dir = 'ASC';
            }
            // If order column is unknown use the default
            if (!in_array($filter_order, $orders))
            {
                $filter_order = 'fam';
            }
            $orderby = ' ORDER BY '.$filter_order.' '.$filter_order_Dir;
            if ($filter_order != 'fam')
            {
                $orderby .= ' , fam ';
            }
            // Return the ORDER BY clause
            return $orderby;
        }
    /**
    * Builds the WHERE part of a query
    *
    * @return string Part of an SQL query
    */
    function _buildQueryWhere()
    {
        global $mainframe, $option;
        $db =& $this->_db;
        // Get the filter values
        $filter_search = $mainframe->getUserStateFromRequest(
            $option.'filter_search_pfam','filter_search_pfam','');
        $filter_search_is_work = $mainframe->getUserStateFromRequest(
            $option.'filter_search_is_work','filter_search_is_work','1');
        // Prepare the WHERE clause
        $where = array();
        // Determine search terms
        if ($filter_search = trim($filter_search))
        {
            $filter_search = JString::strtolower($filter_search);
            $filter_search = $db->getEscaped($filter_search);
            $where[] = ' fam  LIKE "'.$filter_search.'%" ';
        }
        if($filter_search_is_work != '777')
        {
            $where[] = ' is_work = "'.$filter_search_is_work.'" ';
        }
        // return the WHERE clause
        return ($where) ? ' WHERE '.implode(' AND', $where) : '';
    }
    /**
     * Возвращаем список(ID) преподавателей у которых ч-з $days дней день рожденья
     * @param int $days
     * @param bolean $to_string - возвращать массив строк.
     * @return array or string 
     */
    public function soon_birth_day($days = 10, $to_string = FALSE)
    {
        $trainers =& $this->getTable('trainers');
        $trainers->select(array('id','trainer_birthday', 'im', 'fam'));
        $list_trainers = $trainers->execute();
        foreach ($list_trainers as $trainer)
        {
            // Дата дня рожденья преподавателя
            preg_match("/([0-9]{4})-([0-9]{2})-([0-9]{2})/", $trainer['trainer_birthday'], $regs);
            $b_year = $regs[1];
            $b_month = $regs[2];
            $b_day = $regs[3];
            // Сегодняшняя дата
            preg_match("/([0-9]{4})-([0-9]{2})-([0-9]{2})/", date('Y-m-d',  strtotime('+'.$days.' day', time())), $regs);
            $month = $regs[2];
            $day = $regs[3];
            // Сегодняшняя дата, совпадает ли с датой, 
            // которая на $days дней раньше дня рождения преподавателя
            if($b_month == $month AND $b_day == $day)
            {
                if($to_string)
                {
                    $_trainers[] = $b_day.'.'.$b_month.'.'.$b_year.' - '.$trainer['fam'].' '.$trainer['im'];
                }
                else
                {
                    $_trainers[] = $list_trainers[$i];
                }
            }
        }
         return $_trainers;
    }
}